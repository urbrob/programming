<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>z 1</title>
	<style>
		body { margin: 0; padding: 0; font-size: 0; }
		canvas { width: 100%; height: 100%; }
	</style>
</head>
<body>

<div style="position: fixed; lef:10px; top:10px; z-index:1000; width:200px; font-size: 14px">Score: <span id='score'>0</span></div>

<script src="js/three.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
	var WIDTH = window.innerWidth;
	var HEIGHT = window.innerHeight;
	var ROTATE_UP = 0;
	var ROTATE_DOWN = 0;
	var ROTATE_LEFT = 0;
	var ROTATE_RIGHT = 0;

document.addEventListener('keydown',onDocumentKeyDown,false);
document.addEventListener('keyup',onDocumentKeyUp,false);

var clock = new THREE.Clock;
dt = clock.getDelta();

function onDocumentKeyDown(event){
	event = event || window.event;
	var keycode = event.keyCode;
	switch(keycode){
		case 37 :
			console.log("left down");
			ROTATE_LEFT = 1;
			break;
		case 38 :
			console.log("up down");
			ROTATE_UP = 1
			break;
		case 39 :
			console.log("right down");
			ROTATE_RIGHT = 1;
			break;
		case 40 :
			console.log("down down" );
			ROTATE_DOWN = 1;
			break;
	}
}


function onDocumentKeyUp(event){
	event = event || window.event;
	var keycode = event.keyCode;
	switch(keycode){
		case 37 :
			console.log("left up" );
			ROTATE_LEFT = 0;
			break;
		case 38 :
			console.log("up up"   );
			ROTATE_UP = 0;
			break;
		case 39 :
			console.log("right up"   );
			ROTATE_RIGHT = 0;
			break;
		case 40 :
			console.log("down up" );
			ROTATE_DOWN = 0;
			break;
	}
}

function end_game(score){
	$.ajax({
	   type: "GET",
	   dataType: "json",
	   url: "http://nowa.imsi.pl:5000/player/Dawid",
   }).done(function( data ) {
	   if (parseInt(data.p1) < parseInt(score)) {
		   data.p1 = score;
		   $.ajax({
	   	   type: "PUT",
		   data: data,
	   	   dataType: "json",
	   	   url: "http://nowa.imsi.pl:5000/players/" + data.p0,
	      })
	  }})
   }

var renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(WIDTH, HEIGHT);
renderer.setClearColor(0xDDDDDD, 1);
document.body.appendChild(renderer.domElement);

var scene = new THREE.Scene();

var camera = new THREE.PerspectiveCamera(40, WIDTH/HEIGHT, 10, 100);
camera.position.z = 30;
scene.add(camera);

/////////////

var Texture = new THREE.TextureLoader().load("road1.jpg");
Texture.wrapS = THREE.RepeatWrapping;
Texture.wrapT = THREE.RepeatWrapping;
Texture.repeat.set( 1, 10 );

var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide } );
var Geometry = new THREE.PlaneGeometry(40, 250, 1, 1);
var plane = new THREE.Mesh(Geometry, Material);
plane.rotation.set(90, 0, 0);
scene.add(plane);


////////////
var boxGeometry = new THREE.BoxGeometry(10, 10, 10);
var phongMaterial = new THREE.MeshPhongMaterial({color: 0x0069b4});
var cube = new THREE.Mesh(boxGeometry, phongMaterial);
cube.position.x = 0;
cube.position.y = -10;
cube.position.z = 10;
cube.rotation.set(0, 0, 0);
scene.add(cube);

var light = new THREE.PointLight(0xFFFFFF);
light.position.set(-10, 15, 50);
scene.add(light);

var t = 0;
var coolDown = 0, speed = 1, side = 0, brake = 0;
plane.material.map.offset.y = 0;
var brake = 0;
var score = 0;


function render() {
	if (coolDown < 0) coolDown = 0;
	else if (coolDown > 60) coolDown = 60;
	if (coolDown < 10) speed = 10;
	else if (coolDown > 40) speed = 40;
	else speed = coolDown;

	t += 0.01;

	requestAnimationFrame(render);
	if (ROTATE_UP == 1){
		++coolDown;
		plane.material.map.offset.y -= coolDown / 1000;
		brake = 0.1;
		score += speed / 100;
	}
	else if (coolDown > 0){
		--coolDown;
		plane.material.map.offset.y -= coolDown / 2000;
	}
	if (ROTATE_DOWN == 1){
		coolDown = coolDown / brake;
		if (coolDown <= 0 && brake > 0) {
			plane.material.map.offset.y += brake / 75;
			brake--;
		}else {
			brake += 0.1;
		}
	}
	if (ROTATE_LEFT == 1 && camera.position.x > -13.5){
		camera.position.x -= 0.01 * speed;
		cube.position.x -= 0.01 * speed;
	}
	if (ROTATE_RIGHT == 1 && camera.position.x < 13.5){
		camera.position.x += 0.01 * speed;
		cube.position.x += 0.01 * speed;
	}
	renderer.render(scene, camera);
	document.getElementById('score').innerHTML = Math.round(score);
	if (score > 10 && score < 12) end_game();
}

render();
</script>
</body>
</html>
